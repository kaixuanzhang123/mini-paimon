# Mini Paimon - ç®€åŒ–ç‰ˆ Apache Paimon å­˜å‚¨å¼•æ“

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªæ•™å­¦æ€§è´¨çš„ç®€åŒ–ç‰ˆ Apache Paimonï¼Œå®ç°äº† LSM Tree å­˜å‚¨å¼•æ“çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶æä¾›äº† Flink å’Œ Spark è®¡ç®—å¼•æ“çš„é›†æˆæ”¯æŒã€‚

## æ¨¡å—è¯´æ˜

æœ¬é¡¹ç›®åŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š

- **paimon**: æ ¸å¿ƒå­˜å‚¨å¼•æ“ï¼Œå®ç° LSM Treeã€Schema ç®¡ç†ã€Snapshot æœºåˆ¶ç­‰
- **flink**: Flink é›†æˆæ¨¡å—ï¼Œæä¾› Flink SQL è®¿é—® Paimon è¡¨çš„èƒ½åŠ›
- **spark**: Spark é›†æˆæ¨¡å—ï¼Œæä¾› Spark SQL è®¿é—® Paimon è¡¨çš„èƒ½åŠ›

# Mini-Paimon æ¶æ„è®¾è®¡

## ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ (Application)                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  SQL Parser  â”‚  â”‚ Table Managerâ”‚  â”‚ Schema Mgr   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LSM Tree å­˜å‚¨å¼•æ“                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    è¯»å†™åè°ƒå±‚                               â”‚â”‚
â”‚  â”‚  LSMTree: put() / get() / scan() / close()                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     WAL      â”‚â†’ â”‚  MemTable    â”‚â†’ â”‚  Compactor   â”‚        â”‚
â”‚  â”‚              â”‚  â”‚  (Active)    â”‚  â”‚              â”‚        â”‚
â”‚  â”‚ - append()   â”‚  â”‚  (Immutable) â”‚  â”‚ - compact()  â”‚        â”‚
â”‚  â”‚ - recover()  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - merge()    â”‚        â”‚
â”‚  â”‚ - clear()    â”‚         â†“          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Flush when full        â†“                 â”‚
â”‚                              â†“               â†“                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  SSTable æ–‡ä»¶å±‚                             â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Level 0:  [SST] [SST] [SST] [SST]  â† 4+ ä¸ªè§¦å‘ compactionâ”‚â”‚
â”‚  â”‚  Level 1:  [SST] [SST] ... (10x)                          â”‚â”‚
â”‚  â”‚  Level 2:  [SST] [SST] ... (100x)                         â”‚â”‚
â”‚  â”‚  Level 3:  ...                                             â”‚â”‚
â”‚  â”‚  ...                                                       â”‚â”‚
â”‚  â”‚  Level 7:  [SST] ... (æœ€å¤§å±‚çº§)                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–‡ä»¶ç³»ç»Ÿå±‚                                  â”‚
â”‚                                                                 â”‚
â”‚  warehouse/{database}/{table}/                                 â”‚
â”‚  â”œâ”€â”€ data/         â† SSTable æ–‡ä»¶                              â”‚
â”‚  â”‚   â”œâ”€â”€ data-0-000.sst                                       â”‚
â”‚  â”‚   â”œâ”€â”€ data-0-001.sst                                       â”‚
â”‚  â”‚   â”œâ”€â”€ data-1-000.sst                                       â”‚
â”‚  â”‚   â””â”€â”€ ...                                                  â”‚
â”‚  â”œâ”€â”€ wal/          â† WAL æ—¥å¿—                                  â”‚
â”‚  â”‚   â”œâ”€â”€ wal-000.log                                          â”‚
â”‚  â”‚   â””â”€â”€ wal-001.log                                          â”‚
â”‚  â”œâ”€â”€ snapshot/     â† å¿«ç…§æ–‡ä»¶                                  â”‚
â”‚  â”œâ”€â”€ manifest/     â† Manifest æ–‡ä»¶                            â”‚
â”‚  â””â”€â”€ schema/       â† Schema å®šä¹‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°çš„å®Œæ•´åŠŸèƒ½

#### 1. LSM Tree å­˜å‚¨å¼•æ“

**MemTableï¼ˆå†…å­˜è¡¨ï¼‰**
- åŸºäº `ConcurrentSkipListMap` å®ç°æœ‰åºå†…å­˜å­˜å‚¨
- æ”¯æŒå¹¶å‘è¯»å†™ï¼Œè‡ªåŠ¨æŒ‰ RowKey æ’åº
- å†…å­˜é˜ˆå€¼ç®¡ç†ï¼šé»˜è®¤ 64MBï¼Œè¾¾åˆ° 80% è‡ªåŠ¨è§¦å‘ flush
- åŒç¼“å†²æœºåˆ¶ï¼šActive MemTable + Immutable MemTable

**SSTableï¼ˆç£ç›˜æ–‡ä»¶ï¼‰**
- å®Œæ•´çš„æ–‡ä»¶æ ¼å¼è®¾è®¡ï¼šHeader + Data Blocks + Index + Bloom Filter + Footer
- Data Block å¤§å°ï¼š4KBï¼Œæ”¯æŒæ•°æ®å‹ç¼©
- ç¨€ç–ç´¢å¼•ï¼šäºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½æ•°æ®å—
- Bloom Filterï¼š1% è¯¯åˆ¤ç‡ï¼Œå¿«é€Ÿè¿‡æ»¤ä¸å­˜åœ¨çš„ key
- æ–‡ä»¶å‘½åè§„åˆ™ï¼š`data-{level}-{sequence}.sst`

**è¯»å†™æµç¨‹**
- **å†™å…¥**ï¼šMemTable â†’ è¾¾åˆ°é˜ˆå€¼ â†’ flush åˆ° SSTableï¼ˆLevel 0ï¼‰
- **æŸ¥è¯¢**ï¼šActive MemTable â†’ Immutable MemTable â†’ å¤šå±‚ SSTableï¼ˆæŒ‰å±‚çº§ä»ä½åˆ°é«˜ï¼‰
- **æ‰«æ**ï¼šåˆå¹¶æ‰€æœ‰å±‚çº§æ•°æ®ï¼Œå»é‡è¿”å›

#### 2. Write-Ahead Log (WAL)

**æŒä¹…æ€§ä¿è¯**
- å†™å…¥å‰å…ˆè®°å½• WALï¼š`put(row)` â†’ `wal.append(row)` â†’ `memTable.put(row)`
- JSON æ ¼å¼æ—¥å¿—ï¼š`{sequence, type, row}`
- æ¯æ¬¡å†™å…¥åç«‹å³ flushï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–

**å´©æºƒæ¢å¤æœºåˆ¶**
- å¯åŠ¨æ—¶è‡ªåŠ¨æ‰«ææ‰€æœ‰ WAL æ–‡ä»¶
- æŒ‰åºé‡æ”¾æœªæŒä¹…åŒ–çš„æ•°æ®åˆ° MemTable
- æ¢å¤åç«‹å³åˆ é™¤ WAL æ–‡ä»¶ï¼Œé¿å…é‡å¤åŠ è½½

**ç”Ÿå‘½å‘¨æœŸç®¡ç†**
- MemTable flush æˆåŠŸåç«‹å³åˆ é™¤å¯¹åº” WAL
- æ­£å¸¸å…³é—­æ—¶ flush æ‰€æœ‰æ•°æ®å¹¶æ¸…ç† WAL
- ç¡®ä¿ WAL ä¸ MemTable ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼ç»‘å®š

**æ–‡ä»¶ç»„ç»‡**
```
wal/
â”œâ”€â”€ wal-000.log  â† å¯¹åº” sequence 0 çš„ MemTable
â”œâ”€â”€ wal-001.log  â† å¯¹åº” sequence 1 çš„ MemTable
â””â”€â”€ ...          â† æœª flush çš„æ‰å­˜åœ¨
```

#### 3. Compaction æœºåˆ¶

**å¤šå±‚æ¶æ„**
- **Level 0**ï¼šMemTable ç›´æ¥ flush çš„æ–‡ä»¶ï¼ˆå¯èƒ½èŒƒå›´é‡å ï¼‰
- **Level 1-7**ï¼šç»è¿‡ compaction çš„æœ‰åºæ–‡ä»¶ï¼ˆèŒƒå›´ä¸é‡å ï¼‰
- æ¯å±‚å¤§å°çº¦ä¸ºä¸Šå±‚çš„ 10 å€

**è§¦å‘ç­–ç•¥**
- **Level 0**ï¼šæ–‡ä»¶æ•° â‰¥ 4 ä¸ªæ—¶è§¦å‘ â†’ Level 1
- **Level N**ï¼š`size(Level N) / size(Level N+1) > 10` æ—¶è§¦å‘

**åˆå¹¶æµç¨‹**
```
é€‰æ‹©æ–‡ä»¶ â†’ è¯»å–å¹¶åˆå¹¶æ•°æ® â†’ æ’åºå»é‡ â†’ å†™å…¥ç›®æ ‡å±‚çº§ â†’ åˆ é™¤æ—§æ–‡ä»¶
```

**æ–‡ä»¶é€‰æ‹©**
- Level 0ï¼šæ‰€æœ‰æ–‡ä»¶ï¼ˆå› ä¸ºèŒƒå›´å¯èƒ½é‡å ï¼‰
- Level Nï¼šé€‰æ‹©ä¸ä¸‹å±‚èŒƒå›´é‡å çš„æ–‡ä»¶

**ä¼˜åŒ–ç‰¹æ€§**
- ä½¿ç”¨ `TreeMap` è‡ªåŠ¨æ’åºå’Œå»é‡
- ç›¸åŒ key ä¿ç•™æœ€æ–°ç‰ˆæœ¬
- å¢é‡åˆå¹¶ï¼Œé¿å…ä¸€æ¬¡å¤„ç†è¿‡å¤šæ•°æ®

#### 4. éä¸»é”®è¡¨æ”¯æŒ

**è®¾è®¡ç†å¿µ**
- å‚è€ƒå¼€æº Apache Paimonï¼Œæ”¯æŒæ— ä¸»é”®è¡¨
- Schema ä¸­ä¸»é”®åˆ—è¡¨å¯ä»¥ä¸ºç©ºï¼š`primaryKeys = []`

**è‡ªåŠ¨é”®ç”Ÿæˆ**
```java
if (schema.hasPrimaryKey()) {
    key = RowKey.fromRow(row, schema);  // ä½¿ç”¨ä¸»é”®
} else {
    long seq = autoIncrementSequence.getAndIncrement();
    key = new RowKey(String.valueOf(seq).getBytes());  // è‡ªå¢åºåˆ—
}
```

**ä½¿ç”¨åœºæ™¯**
- æ—¥å¿—æ•°æ®å­˜å‚¨ï¼ˆå…è®¸å®Œå…¨é‡å¤ï¼‰
- è¿½åŠ å†™å…¥åœºæ™¯
- ä¸éœ€è¦ä¸»é”®çº¦æŸçš„ä¸´æ—¶è¡¨

#### 5. Schema ç®¡ç†

**Schema ç‰ˆæœ¬æ§åˆ¶**
- Schema ID ä» 0 å¼€å§‹é€’å¢
- æ¯æ¬¡ Schema å˜æ›´åˆ›å»ºæ–°ç‰ˆæœ¬
- æ”¯æŒ Schema æ¼”åŒ–éªŒè¯

**å­—æ®µå®šä¹‰**
```java
Field(name, dataType, nullable)
// æ”¯æŒçš„ç±»å‹ï¼šINT, LONG, STRING, BOOLEAN
```

**æŒä¹…åŒ–**
```
schema/
â”œâ”€â”€ schema-0  â† åˆå§‹ç‰ˆæœ¬
â”œâ”€â”€ schema-1  â† æ¼”åŒ–åç‰ˆæœ¬
â””â”€â”€ ...
```

#### 6. Snapshot å¿«ç…§æœºåˆ¶

**ç‰ˆæœ¬è¿½è¸ª**
- æ¯æ¬¡ flush åˆ›å»ºæ–° Snapshot
- è®°å½• Schema ID å’Œ Manifest ä¿¡æ¯
- æ”¯æŒæ—¶é—´æ—…è¡ŒæŸ¥è¯¢

**Snapshot å†…å®¹**
```json
{
  "snapshotId": 1,
  "schemaId": 0,
  "commitTime": 1699000000,
  "manifestList": "manifest/manifest-list-1"
}
```

**æ–‡ä»¶ç»„ç»‡**
```
snapshot/
â”œâ”€â”€ snapshot-0
â”œâ”€â”€ snapshot-1
â”œâ”€â”€ LATEST  â† æŒ‡å‘æœ€æ–°å¿«ç…§
â””â”€â”€ ...
```

#### 7. Manifest æ–‡ä»¶ç®¡ç†

**è¿½è¸ªæ•°æ®å˜æ›´**
- è®°å½•æ¯ä¸ª SSTable çš„æ·»åŠ å’Œåˆ é™¤
- åŒ…å«æ–‡ä»¶å…ƒä¿¡æ¯ï¼šè·¯å¾„ã€å±‚çº§ã€èŒƒå›´ã€è¡Œæ•°

**ManifestEntry**
```java
{
  "kind": "ADD",           // ADD æˆ– DELETE
  "file": "data-0-001.sst",
  "level": 0,
  "minKey": RowKey,
  "maxKey": RowKey,
  "rowCount": 1000
}
```

**æ–‡ä»¶ç»„ç»‡**
```
manifest/
â”œâ”€â”€ manifest-list-1      â† Snapshot 1 çš„æ¸…å•
â”œâ”€â”€ manifest-abc123      â† å…·ä½“çš„å˜æ›´æ–‡ä»¶
â””â”€â”€ ...
```

**æ–‡ä»¶ç»„ç»‡**
```
warehouse/{database}/{table}/
â”œâ”€â”€ data/              â† SSTable æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ data-0-000.sst
â”‚   â”œâ”€â”€ data-0-001.sst
â”‚   â”œâ”€â”€ data-1-000.sst
â”‚   â””â”€â”€ ...
â”œâ”€â”€ wal/               â† Write-Ahead Log
â”‚   â”œâ”€â”€ wal-000.log    (ä»…æœª flush çš„å­˜åœ¨)
â”‚   â””â”€â”€ ...
â”œâ”€â”€ schema/            â† Schema ç‰ˆæœ¬
â”‚   â”œâ”€â”€ schema-0
â”‚   â””â”€â”€ ...
â”œâ”€â”€ snapshot/          â† å¿«ç…§æ–‡ä»¶
â”‚   â”œâ”€â”€ snapshot-0
â”‚   â”œâ”€â”€ LATEST
â”‚   â””â”€â”€ ...
â””â”€â”€ manifest/          â† æ•°æ®å˜æ›´è®°å½•
    â”œâ”€â”€ manifest-list-1
    â””â”€â”€ ...
```

### ğŸ“š å®Œæ•´æ–‡æ¡£

- [advanced_features.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/advanced_features.md) - é«˜çº§ç‰¹æ€§è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- [implementation_summary.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/implementation_summary.md) - å®ç°æ€»ç»“å’Œä½¿ç”¨æŒ‡å—
- [architecture.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/architecture.md) - ç³»ç»Ÿæ¶æ„å’Œæµç¨‹å›¾
- [wal_fix_summary.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/wal_fix_summary.md) - WAL æ•°æ®é‡å¤é—®é¢˜ä¿®å¤è¯´æ˜
- [lsm_tree_implementation.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/lsm_tree_implementation.md) - LSM Tree å®ç°ç»†èŠ‚
- [schema_management.md](file:///Users/kaixuanzhang/alibaba/mini-paimon/schema_management.md) - Schema ç®¡ç†æ–‡æ¡£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘é¡¹ç›®
```bash
cd /Users/kaixuanzhang/alibaba/mini-paimon
mvn clean compile
```

### è¿è¡Œç¤ºä¾‹ç¨‹åº
```bash
# è¿è¡Œé«˜çº§ç‰¹æ€§æ¼”ç¤º
mvn exec:java -Dexec.mainClass="com.minipaimon.storage.AdvancedFeaturesExample"

# è¿è¡Œ LSM Tree ç¤ºä¾‹
mvn exec:java -Dexec.mainClass="com.minipaimon.storage.LSMTreeExample"

# è¿è¡Œ Schema ç®¡ç†ç¤ºä¾‹
mvn exec:java -Dexec.mainClass="com.minipaimon.metadata.SchemaManagementExample"
```

### è¿è¡Œæµ‹è¯•
```bash
mvn test
```

## ğŸ’¡ ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºæœ¬è¯»å†™
```java
// åˆ›å»º Schema
Schema schema = new Schema(
    1,
    Arrays.asList(
        new Field("id", DataType.INT, false),
        new Field("name", DataType.STRING, true)
    ),
    Arrays.asList("id"),  // ä¸»é”®
    Arrays.asList()       // åˆ†åŒºé”®
);

// åˆ›å»º LSMTree
PathFactory pathFactory = new PathFactory("warehouse");
LSMTree lsmTree = new LSMTree(schema, pathFactory, "my_db", "my_table");

// å†™å…¥æ•°æ®
lsmTree.put(new Row(new Object[]{1, "Alice"}));
lsmTree.put(new Row(new Object[]{2, "Bob"}));

// æŸ¥è¯¢æ•°æ®
RowKey key = RowKey.fromRow(new Row(new Object[]{1, "Alice"}), schema);
Row row = lsmTree.get(key);

// æ‰«ææ‰€æœ‰æ•°æ®
List<Row> allRows = lsmTree.scan();

// å…³é—­
lsmTree.close();
```

### ç¤ºä¾‹ 2ï¼šéä¸»é”®è¡¨
```java
// åˆ›å»ºæ— ä¸»é”® Schema
Schema noPkSchema = new Schema(
    1,
    Arrays.asList(
        new Field("message", DataType.STRING, true),
        new Field("timestamp", DataType.LONG, true)
    ),
    Arrays.asList(),  // ç©ºä¸»é”®åˆ—è¡¨
    Arrays.asList()
);

LSMTree lsmTree = new LSMTree(noPkSchema, pathFactory, "log_db", "log_table");

// å¯ä»¥æ’å…¥å®Œå…¨ç›¸åŒçš„æ•°æ®
lsmTree.put(new Row(new Object[]{"error occurred", 1699000000L}));
lsmTree.put(new Row(new Object[]{"error occurred", 1699000000L}));  // å…è®¸

lsmTree.close();
```

### ç¤ºä¾‹ 3ï¼šWAL æ¢å¤
```java
// ç¬¬ä¸€æ¬¡è¿è¡Œ
LSMTree tree1 = new LSMTree(schema, pathFactory, "db", "table");
tree1.put(new Row(new Object[]{1, "Alice"}));
tree1.put(new Row(new Object[]{2, "Bob"}));
// æ¨¡æ‹Ÿå´©æºƒï¼Œä¸è°ƒç”¨ close()

// é‡å¯åè‡ªåŠ¨æ¢å¤
LSMTree tree2 = new LSMTree(schema, pathFactory, "db", "table");
List<Row> recovered = tree2.scan();
System.out.println("Recovered " + recovered.size() + " rows");  // è¾“å‡º: 2
tree2.close();
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å®ç°ç±» |
|------|------|--------|
| MemTable | å†…å­˜å­˜å‚¨ | `MemTable.java` |
| SSTable | ç£ç›˜æ–‡ä»¶ | `SSTable.java`, `SSTableWriter.java`, `SSTableReader.java` |
| WAL | æ—¥å¿—æ¢å¤ | `WriteAheadLog.java` |
| Compactor | æ–‡ä»¶åˆå¹¶ | `Compactor.java` |
| LSMTree | ä¸»åè°ƒå™¨ | `LSMTree.java` |
| Schema | è¡¨ç»“æ„ | `Schema.java`, `SchemaManager.java` |
| Snapshot | ç‰ˆæœ¬æ§åˆ¶ | `Snapshot.java`, `SnapshotManager.java` |
| Manifest | å˜æ›´è¿½è¸ª | `ManifestFile.java`, `ManifestList.java` |

### æ€§èƒ½ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | æ€§èƒ½æŒ‡æ ‡ |
|------|------|----------|
| å†™å…¥åå | å…ˆå†™ WALï¼Œå†å†™ MemTable | ~10K ops/s |
| è¯»å–å»¶è¿Ÿ | Bloom Filter + ç´¢å¼• + Cache | < 1ms (ç¼“å­˜å‘½ä¸­) |
| ç©ºé—´æ”¾å¤§ | Compaction å‹ç¼© | ~1.5x |
| æ¢å¤æ—¶é—´ | WAL é‡æ”¾ | ç§’çº§ |

## ğŸ“Š é¡¹ç›®ç»Ÿè®¡

- **ä»£ç è¡Œæ•°**: ~3500 è¡Œ Java ä»£ç 
- **æ ¸å¿ƒç±»**: 35 ä¸ª
- **æµ‹è¯•è¦†ç›–**: ä¸»è¦åŠŸèƒ½ç‚¹
- **æ–‡æ¡£**: 6 ä¸ªè¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: æ•°æ®å†™å…¥åé‡å¯ä¸¢å¤±ï¼Ÿ**
A: æ£€æŸ¥æ˜¯å¦æ­£å¸¸è°ƒç”¨ `close()` æˆ– WAL æ˜¯å¦æ­£ç¡®æ¢å¤ã€‚

**Q: æ•°æ®é‡å¤ï¼Ÿ**
A: å·²ä¿®å¤ã€‚ç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç ï¼ŒWAL åœ¨ flush åä¼šè‡ªåŠ¨åˆ é™¤ã€‚

**Q: Compaction æœªè§¦å‘ï¼Ÿ**
A: Level 0 éœ€è¦è‡³å°‘ 4 ä¸ªæ–‡ä»¶æ‰ä¼šè§¦å‘ã€‚å¯ä»¥æ’å…¥æ›´å¤šæ•°æ®æµ‹è¯•ã€‚

**Q: æŸ¥è¯¢æ€§èƒ½æ…¢ï¼Ÿ**
A: æ£€æŸ¥ Bloom Filter æ˜¯å¦ç”Ÿæ•ˆï¼Œç´¢å¼•æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ·»åŠ æ–°æ•°æ®ç±»å‹**
   - ä¿®æ”¹ `DataType.java` æšä¸¾
   - æ›´æ–° `RowKey.java` åºåˆ—åŒ–é€»è¾‘
   - æ›´æ–° `Row.java` éªŒè¯é€»è¾‘

2. **ä¼˜åŒ– Compaction**
   - è°ƒæ•´ `Compactor.java` ä¸­çš„è§¦å‘é˜ˆå€¼
   - å®ç°å¹¶è¡Œ Compaction
   - æ·»åŠ å¢é‡åˆå¹¶ç­–ç•¥

3. **å¢å¼º WAL**
   - æ·»åŠ æ‰¹é‡å†™å…¥
   - å®ç°å¼‚æ­¥åˆ·ç›˜
   - æ·»åŠ  Checksum æ ¡éªŒ

### è°ƒè¯•æŠ€å·§

```bash
# æŸ¥çœ‹ WAL å†…å®¹
cat warehouse/db/table/wal/wal-000.log

# æŸ¥çœ‹ SSTable ç»“æ„
mvn exec:java -Dexec.mainClass="com.minipaimon.storage.SSTableAnalyzer" \
  -Dexec.args="warehouse/db/table/data/data-0-000.sst"

# å¼€å¯ DEBUG æ—¥å¿—
export MAVEN_OPTS="-Dorg.slf4j.simpleLogger.defaultLogLevel=debug"
mvn exec:java ...
```

# Mini Paimon é¡¹ç›®è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£å°†æŒ‰æ­¥éª¤æ‹†è§£ä¸€ä¸ª Mini Paimon é¡¹ç›®çš„å®ç°æµç¨‹ï¼Œç›®æ ‡æ˜¯æ¨¡ä»¿ Apache Paimon çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œä½†åŠŸèƒ½ä¸Šç®€åŒ–ï¼Œæ–¹ä¾¿å­¦ä¹  LSM Tree å­˜å‚¨ç»“æ„ã€ç´¢å¼•ç®¡ç†ã€è¡¨å…ƒæ•°æ®ç®¡ç†ã€Snapshot/Manifest æ–‡ä»¶ä»¥åŠç®€å• SQL è§£æä¸æ‰§è¡Œã€‚

## 1. é¡¹ç›®æ€»ä½“ç»“æ„è®¾è®¡

Mini Paimon å°†åˆ†ä¸ºä»¥ä¸‹æ¨¡å—ï¼š

1. **å­˜å‚¨å±‚**ï¼šå®ç°ç®€åŒ–ç‰ˆ LSM Treeï¼Œç”¨äºæ•°æ®æ–‡ä»¶å­˜å‚¨ä¸ç´¢å¼•ã€‚
2. **å…ƒæ•°æ®ç®¡ç†å±‚**ï¼šç®¡ç†è¡¨å®šä¹‰ï¼ˆSchemaï¼‰ã€è¡¨é…ç½®ä»¥åŠè¡¨çš„ç”Ÿå‘½å‘¨æœŸã€‚
3. **æ–‡ä»¶ç®¡ç†å±‚**ï¼šæ¨¡ä»¿ Paimon çš„ Snapshot å’Œ Manifest æ–‡ä»¶ç»“æ„åŠæ•°æ®å†™å…¥æµç¨‹ã€‚
4. **SQL å±‚**ï¼šç®€å•çš„ SQL è§£æä¸æ‰§è¡Œï¼ˆæ”¯æŒ INSERTã€SELECTï¼‰ã€‚
5. **å·¥å…·ä¸è¾…åŠ©æ¨¡å—**ï¼šæ—¥å¿—ã€é…ç½®ã€æµ‹è¯•å·¥å…·ã€‚

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½æ­å»º

#### ä»»åŠ¡ 1.1ï¼šé¡¹ç›®ç»“æ„åˆå§‹åŒ–

**ç›®æ ‡**ï¼šå»ºç«‹é¡¹ç›®åŸºæœ¬æ¡†æ¶

- åˆ›å»º Maven/Gradle é¡¹ç›®
- å®šä¹‰åŒ…ç»“æ„ï¼š

```
com.minipaimon
â”œâ”€â”€ storage        # å­˜å‚¨å¼•æ“
â”œâ”€â”€ metadata       # å…ƒæ•°æ®ç®¡ç†
â”œâ”€â”€ manifest       # Manifest æ–‡ä»¶ç®¡ç†
â”œâ”€â”€ snapshot       # Snapshot ç®¡ç†
â”œâ”€â”€ index          # ç´¢å¼•å®ç°
â”œâ”€â”€ sql            # SQL è§£æå™¨
â””â”€â”€ utils          # å·¥å…·ç±»
```

- æ·»åŠ ä¾èµ–ï¼šGuavaã€Jackson (JSONåºåˆ—åŒ–)ã€ANTLR (SQLè§£æ)

#### ä»»åŠ¡ 1.2ï¼šåŸºç¡€æ•°æ®ç»“æ„å®šä¹‰

**ç›®æ ‡**ï¼šå®šä¹‰æ ¸å¿ƒæ•°æ®æ¨¡å‹

- å®ç° DataType æšä¸¾ (INT, LONG, STRING, BOOLEAN)
- å®ç° Field ç±»ï¼ˆå­—æ®µåã€ç±»å‹ã€æ˜¯å¦å¯ç©ºï¼‰
- å®ç° Schema ç±»ï¼ˆå­—æ®µåˆ—è¡¨ã€ä¸»é”®å®šä¹‰ï¼‰
- å®ç° Row ç±»ï¼ˆæ•°æ®è¡Œçš„è¡¨ç¤ºï¼‰
- å®ç° RowKey ç±»ï¼ˆä¸»é”®çš„åºåˆ—åŒ–è¡¨ç¤ºï¼‰

ä»£ç ç¤ºä¾‹ï¼š

```java
public class Schema {
    private List<Field> fields;
    private List<String> primaryKeys;
    private int schemaId;
}
```

## 2. LSM Tree å­˜å‚¨å¼•æ“

### æ¦‚è¿°

LSM Treeï¼ˆLog-Structured Merge Treeï¼‰æ˜¯ Paimon å­˜å‚¨å¼•æ“çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚æœ¬é˜¶æ®µå°†å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ LSM Treeï¼ŒåŒ…å«å†…å­˜è¡¨ã€æŒä¹…åŒ–æ–‡ä»¶æ ¼å¼ã€è¯»å†™æµç¨‹å’Œå‹ç¼©æœºåˆ¶ã€‚

### ä»»åŠ¡ 2.1ï¼šMemTable å®ç°

#### 2.1.1 æ ¸å¿ƒæ•°æ®ç»“æ„

**MemTable ç±»è®¾è®¡**

```
MemTable
â”œâ”€â”€ ConcurrentSkipListMap<RowKey, Row>  // ä¸»å­˜å‚¨
â”œâ”€â”€ AtomicLong memorySize               // å½“å‰å†…å­˜å ç”¨
â”œâ”€â”€ long createTimestamp                // åˆ›å»ºæ—¶é—´æˆ³
â”œâ”€â”€ long sequenceNumber                 // åºåˆ—å·
â””â”€â”€ ReentrantReadWriteLock lock         // è¯»å†™é”
```

**å…³é”®é…ç½®å‚æ•°**

- memTableSize: 64MBï¼ˆé»˜è®¤å€¼ï¼‰
- flushThreshold: 0.8ï¼ˆè§¦å‘ flush çš„é˜ˆå€¼æ¯”ä¾‹ï¼‰
- maxMemTables: 3ï¼ˆæœ€å¤šåŒæ—¶å­˜åœ¨çš„ MemTable æ•°é‡ï¼‰

#### 2.1.2 æ ¸å¿ƒæ–¹æ³•å®ç°ç»†èŠ‚

**put(RowKey, Row) æ–¹æ³•**

*å‚æ•°æ ¡éªŒ*
- æ£€æŸ¥ RowKey æ˜¯å¦ä¸º null
- æ£€æŸ¥ Row æ•°æ®å®Œæ•´æ€§

*å†™å…¥æµç¨‹*
- å…ˆå†™ WALï¼ˆWrite-Ahead Logï¼‰
- è®¡ç®— Row çš„å†…å­˜å ç”¨å¤§å°ï¼ˆåŒ…æ‹¬ key + value + metadataï¼‰
- ä½¿ç”¨ ConcurrentSkipListMap æ’å…¥æ•°æ®
- æ›´æ–° memorySize è®¡æ•°å™¨
- å¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼Œéœ€è¦å‡å»æ—§å€¼çš„å¤§å°

*è§¦å‘ flush æ£€æŸ¥*
- åˆ¤æ–­å½“å‰å†…å­˜å ç”¨æ˜¯å¦è¶…è¿‡é˜ˆå€¼
- å¦‚æœè¶…è¿‡ï¼Œæ ‡è®°å½“å‰ MemTable ä¸º Immutable
- åˆ›å»ºæ–°çš„ Active MemTable
- è§¦å‘å¼‚æ­¥ flush ä»»åŠ¡

**get(RowKey) æ–¹æ³•**

*æŸ¥è¯¢æµç¨‹*
- å…ˆåœ¨ Active MemTable ä¸­æŸ¥æ‰¾
- å¦‚æœæœªæ‰¾åˆ°ï¼Œä¾æ¬¡æŸ¥è¯¢ Immutable MemTables
- è¿”å›æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ï¼ˆæ ¹æ® sequenceNumberï¼‰

*å¹¶å‘æ§åˆ¶*
- ä½¿ç”¨è¯»é”ä¿æŠ¤æŸ¥è¯¢æ“ä½œ
- é¿å…åœ¨ flush è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸€è‡´

*å†…å­˜å ç”¨è®¡ç®—*

```
Row Memory Size = 
  + RowKey size (å­—èŠ‚æ•°ç»„é•¿åº¦)
  + Column values size (æ‰€æœ‰åˆ—å€¼çš„å­—èŠ‚æ•°)
  + Metadata size (æ—¶é—´æˆ³ã€åºåˆ—å·ç­‰)
  + SkipList node overhead (~40 bytes per entry)
```

#### 2.1.3 WAL (Write-Ahead Log) å®ç°

**WAL æ–‡ä»¶æ ¼å¼**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Magic Number (4 bytes)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Version (4 bytes)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Record 1:                     â”‚
â”‚    - Length (4 bytes)          â”‚
â”‚    - Type (1 byte)             â”‚ â† PUT/DELETE
â”‚    - RowKey (variable)         â”‚
â”‚    - Row Data (variable)       â”‚
â”‚    - Checksum (4 bytes)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Record 2...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**WAL æ“ä½œæµç¨‹**

*å†™å…¥*
- è¿½åŠ å†™å…¥ï¼ˆAppend-Onlyï¼‰
- æ¯æ¡è®°å½•åŒ…å« CRC32 æ ¡éªŒå’Œ
- å®šæœŸ fsync åˆ·ç›˜ï¼ˆå¯é…ç½®é—´éš”ï¼‰

*æ¢å¤*
- å¯åŠ¨æ—¶æ‰«æ WAL æ–‡ä»¶
- æŒ‰é¡ºåºé‡æ”¾æ‰€æœ‰è®°å½•
- é‡å»º MemTable çŠ¶æ€
- åˆ é™¤å·² flush çš„ WAL æ–‡ä»¶

*æ–‡ä»¶ç®¡ç†*
- å‘½åè§„åˆ™ï¼šwal-{sequenceNumber}.log
- æ¯ä¸ª MemTable å¯¹åº”ä¸€ä¸ª WAL æ–‡ä»¶
- Flush å®Œæˆååˆ é™¤å¯¹åº” WAL

#### 2.1.4 MemTable çŠ¶æ€ç®¡ç†

**çŠ¶æ€è½¬æ¢**

```
ACTIVE â†’ IMMUTABLE â†’ FLUSHING â†’ FLUSHED
```

- ACTIVE: å¯å†™å…¥çŠ¶æ€
- IMMUTABLE: åªè¯»çŠ¶æ€ï¼Œç­‰å¾… flush
- FLUSHING: æ­£åœ¨å†™å…¥ç£ç›˜
- FLUSHED: å·²æŒä¹…åŒ–ï¼Œå¯ä»¥åˆ é™¤

### ä»»åŠ¡ 2.2ï¼šSSTable æ–‡ä»¶æ ¼å¼è®¾è®¡

#### 2.2.1 æ•´ä½“æ–‡ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Offset: 0
â”‚    File Header (32 bytes)      â”‚
â”‚  - Magic Number                â”‚
â”‚  - Version                     â”‚
â”‚  - Compression Type            â”‚
â”‚  - Create Timestamp            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Data Block 1 (4KB)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Restart Points Array     â”‚  â”‚
â”‚  â”‚ Entry 1: key1, value1    â”‚  â”‚
â”‚  â”‚ Entry 2: key2, value2    â”‚  â”‚
â”‚  â”‚ ...                      â”‚  â”‚
â”‚  â”‚ Block Footer             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Data Block 2...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Meta Block                  â”‚
â”‚  - Statistics (min/max key)    â”‚
â”‚  - Column Schema               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Index Block                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Entry 1:                 â”‚  â”‚
â”‚  â”‚   - First Key            â”‚  â”‚
â”‚  â”‚   - Block Offset         â”‚  â”‚
â”‚  â”‚   - Block Size           â”‚  â”‚
â”‚  â”‚ Entry 2...               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Bloom Filter Block          â”‚
â”‚  - Bit Array                   â”‚
â”‚  - Hash Function Count         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Footer (48 bytes)           â”‚
â”‚  - Meta Block Handle           â”‚
â”‚  - Index Block Handle          â”‚
â”‚  - Bloom Filter Handle         â”‚
â”‚  - Row Count                   â”‚
â”‚  - Checksum                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  End of File
```

#### 2.2.2 Data Block è¯¦ç»†æ ¼å¼

**æ•°æ®å‹ç¼©ä¸ç¼–ç **

*å‰ç¼€å‹ç¼©*
- ç›¸é‚» key é€šå¸¸æœ‰å…¬å…±å‰ç¼€
- åªå­˜å‚¨ä¸åŒçš„åç¼€éƒ¨åˆ†
- è®¾ç½® Restart Pointï¼ˆæ¯ 16 ä¸ª keyï¼‰

*Delta Encoding*
- å¯¹æ•°å€¼ç±»å‹åˆ—ä½¿ç”¨å·®å€¼ç¼–ç 
- å‡å°‘å­˜å‚¨ç©ºé—´

**Data Block å†…éƒ¨ç»“æ„**

*Entry Format:*

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Shared Key Length (varint)     â”‚ â† ä¸å‰ä¸€ä¸ª key çš„å…¬å…±å‰ç¼€é•¿åº¦
â”‚ Unshared Key Length (varint)   â”‚ â† éå…¬å…±éƒ¨åˆ†é•¿åº¦
â”‚ Value Length (varint)           â”‚
â”‚ Unshared Key Data              â”‚
â”‚ Value Data                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

*Restart Points Array:*

```
[offset1, offset2, ..., offsetN, restart_count]
```

#### 2.2.3 Index Block è®¾è®¡

**ç¨€ç–ç´¢å¼•ç»“æ„**

*Index Entry:*

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Separator Key                  â”‚ â† åˆ†éš”é”®ï¼ˆ>= last key of block i, < first key of block i+1)
â”‚ Block Offset (8 bytes)         â”‚
â”‚ Block Size (4 bytes)           â”‚
â”‚ First Key Length (4 bytes)     â”‚
â”‚ First Key Data                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**
- ä½¿ç”¨æœ€çŸ­çš„åˆ†éš”é”®å‡å°‘ç´¢å¼•å¤§å°
- æ”¯æŒäºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½ Block
- åŠ è½½æ—¶ç¼“å­˜åœ¨å†…å­˜ä¸­

#### 2.2.4 Bloom Filter Block

**Bloom Filter é…ç½®**
- Bits per Key: 10ï¼ˆè¯¯åˆ¤ç‡çº¦ 1%ï¼‰
- Hash Function Count: 7
- å®ç°: Murmur3 Hash

**å­˜å‚¨æ ¼å¼**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bits per Key (4 bytes)         â”‚
â”‚ Hash Count (4 bytes)           â”‚
â”‚ Total Bits (8 bytes)           â”‚
â”‚ Bit Array (variable)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.5 Footer æ ¼å¼

**Footer (48 bytes fixed):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Meta Block Offset (8 bytes)    â”‚
â”‚ Meta Block Size (4 bytes)      â”‚
â”‚ Index Block Offset (8 bytes)   â”‚
â”‚ Index Block Size (4 bytes)     â”‚
â”‚ Bloom Filter Offset (8 bytes)  â”‚
â”‚ Bloom Filter Size (4 bytes)    â”‚
â”‚ Row Count (8 bytes)            â”‚
â”‚ Magic Number (4 bytes)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»åŠ¡ 2.3ï¼šSSTable Writer

#### 2.3.1 SSTableWriter ç±»è®¾è®¡

```
SSTableWriter
â”œâ”€â”€ FileChannel outputChannel
â”œâ”€â”€ DataBlockBuilder currentBlock
â”œâ”€â”€ List<IndexEntry> indexEntries
â”œâ”€â”€ BloomFilterBuilder bloomFilter
â”œâ”€â”€ long currentOffset
â””â”€â”€ Statistics stats (min/max key, row count)
```

#### 2.3.2 Flush æµç¨‹

**æ•´ä½“æµç¨‹**

```
MemTable (Immutable)
    â†“
1. åˆ›å»º SSTableWriter
    â†“
2. éå†æœ‰åºæ•°æ®
    â†“
3. å†™å…¥ Data Blocks
    â†“
4. æ„å»º Index
    â†“
5. ç”Ÿæˆ Bloom Filter
    â†“
6. å†™å…¥ Footer
    â†“
7. å…³é—­æ–‡ä»¶
    â†“
8. æ³¨å†Œåˆ° Manifest
```

**è¯¦ç»†æ­¥éª¤**

*Step 1: åˆå§‹åŒ–*
- åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼ˆ.tmp åç¼€ï¼‰
- åˆå§‹åŒ– DataBlockBuilderï¼ˆ4KB ç¼“å†²åŒºï¼‰
- åˆå§‹åŒ– BloomFilterBuilder
- å†™å…¥ File Header

*Step 2: å†™å…¥æ•°æ®è¡Œ*

```
for each (key, row) in MemTable:
    1. æ·»åŠ  key åˆ° Bloom Filter
    2. åºåˆ—åŒ– row æ•°æ®
    3. æ·»åŠ åˆ° currentBlock
    4. å¦‚æœ block æ»¡äº†ï¼ˆ>= 4KBï¼‰:
        a. å‹ç¼© blockï¼ˆå¯é€‰ï¼šSnappy/LZ4ï¼‰
        b. è®¡ç®— checksum
        c. å†™å…¥ç£ç›˜
        d. è®°å½• index entryï¼ˆfirst key, offset, sizeï¼‰
        e. é‡ç½® currentBlock
```

*Step 3: å†™å…¥ Meta Block*
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆmin/max key, row countï¼‰
- Schema ä¿¡æ¯
- Compression ç±»å‹

*Step 4: å†™å…¥ Index Block*
- å°†æ‰€æœ‰ IndexEntry åºåˆ—åŒ–
- å†™å…¥ç£ç›˜
- è®°å½• offset å’Œ size

*Step 5: å†™å…¥ Bloom Filter*
- åºåˆ—åŒ– bit array
- å†™å…¥ç£ç›˜
- è®°å½• offset å’Œ size

*Step 6: å†™å…¥ Footer*
- å¡«å……æ‰€æœ‰ block handles
- è®¡ç®—æ–‡ä»¶ checksum
- å†™å…¥å›ºå®š 48 å­—èŠ‚

*Step 7: åŸå­é‡å‘½å*
- fsync ç¡®ä¿æ•°æ®è½ç›˜
- å°† .tmp æ–‡ä»¶é‡å‘½åä¸º .sst

#### 2.3.3 æ–‡ä»¶å‘½åè§„åˆ™

**æ ¼å¼**: {level}-{sequence}-{uuid}.sst

**ä¾‹å¦‚**:
- 0-00001-a1b2c3d4.sst  (Level 0, åºåˆ—å· 1)
- 1-00025-e5f6g7h8.sst  (Level 1, åºåˆ—å· 25)

#### 2.3.4 å¹¶å‘æ§åˆ¶

- æ¯ä¸ª MemTable flush ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹
- ä½¿ç”¨ Semaphore é™åˆ¶å¹¶å‘ flush æ•°é‡
- Flush è¿‡ç¨‹ä¸­ä¸é˜»å¡æ–°å†™å…¥

### ä»»åŠ¡ 2.4ï¼šSSTable Reader

#### 2.4.1 SSTableReader ç±»è®¾è®¡

```
SSTableReader
â”œâ”€â”€ FileChannel inputChannel
â”œâ”€â”€ MappedByteBuffer fileMapping (å¯é€‰)
â”œâ”€â”€ Footer footer
â”œâ”€â”€ IndexBlock indexBlock (cached in memory)
â”œâ”€â”€ BloomFilter bloomFilter (cached in memory)
â”œâ”€â”€ LRUCache<BlockOffset, DataBlock> blockCache
â””â”€â”€ Statistics stats
```

#### 2.4.2 åˆå§‹åŒ–æµç¨‹

```
1. æ‰“å¼€æ–‡ä»¶
   â†“
2. è¯»å– Footer (ä»æ–‡ä»¶æœ«å°¾å€’æ•° 48 å­—èŠ‚)
   â†“
3. éªŒè¯ Magic Number
   â†“
4. è¯»å–å¹¶ç¼“å­˜ Index Block
   â†“
5. è¯»å–å¹¶ç¼“å­˜ Bloom Filter
   â†“
6. å‡†å¤‡å°±ç»ª
```

#### 2.4.3 ç‚¹æŸ¥è¯¢ get(RowKey) å®ç°

**å®Œæ•´æŸ¥è¯¢æµç¨‹**

```
Query: get(key="user123")
    â†“
Step 1: Bloom Filter æ£€æŸ¥
    if NOT bloom.mightContain(key):
        return null (å¿«é€Ÿæ’é™¤)
    â†“
Step 2: Index Block äºŒåˆ†æŸ¥æ‰¾
    æ‰¾åˆ°åŒ…å« key çš„ Data Block
    (å®šä½åˆ° block offset å’Œ size)
    â†“
Step 3: è¯»å– Data Block
    å…ˆæ£€æŸ¥ Block Cache
    if cache miss:
        ä»æ–‡ä»¶è¯»å– block
        è§£å‹ç¼©ï¼ˆå¦‚æœéœ€è¦ï¼‰
        åŠ å…¥ cache
    â†“
Step 4: Data Block å†…äºŒåˆ†æŸ¥æ‰¾
    ä½¿ç”¨ Restart Points åŠ é€Ÿ
    æ‰¾åˆ°ç›®æ ‡ entry
    â†“
Step 5: ååºåˆ—åŒ– Row
    è¿”å›ç»“æœ
```

**ä¼˜åŒ–æŠ€å·§**

*Block Cache*
- LRU ç­–ç•¥
- é»˜è®¤å¤§å°ï¼š256MB
- ç¼“å­˜è§£å‹åçš„ block

*é¢„è¯»å–ï¼ˆRead-Aheadï¼‰*
- æ‰«æåœºæ™¯ä¸‹é¢„è¯»ç›¸é‚» block
- å‡å°‘ IO æ¬¡æ•°

*å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰*
- å°æ–‡ä»¶ä½¿ç”¨ MappedByteBuffer

## 3. ç´¢å¼•ç³»ç»Ÿ

### ä»»åŠ¡ 3.1ï¼šBloom Filter ç´¢å¼•

**ç›®æ ‡**ï¼šå¿«é€Ÿåˆ¤æ–­ Key æ˜¯å¦å­˜åœ¨
- ä½¿ç”¨ Guava çš„ BloomFilter
- ä¸ºæ¯ä¸ª SSTable åˆ›å»ºç‹¬ç«‹çš„ Bloom Filter
- è®¾ç½®åˆç†çš„è¯¯åˆ¤ç‡ï¼ˆ1%ï¼‰
- åºåˆ—åŒ–åˆ° SSTable æ–‡ä»¶

### ä»»åŠ¡ 3.2ï¼šç¨€ç–ç´¢å¼•å®ç°

**ç›®æ ‡**ï¼šå¿«é€Ÿå®šä½æ•°æ®å—
- å®ç° IndexEntry ç±»ï¼ˆKey + Offsetï¼‰
- åœ¨å†™å…¥æ—¶æ¯ä¸ª DataBlock è®°å½•ä¸€ä¸ªç´¢å¼•é¡¹
- åŠ è½½æ—¶å°†ç´¢å¼•åŠ è½½åˆ°å†…å­˜
- å®ç°äºŒåˆ†æŸ¥æ‰¾å®šä½ç®—æ³•

### ä»»åŠ¡ 3.3ï¼šæ•°æ®å—ç´¢å¼•å®ç°

1. **å®ç° Compaction æœºåˆ¶**: å¤šå±‚ SSTable åˆå¹¶
2. **WALï¼ˆWrite-Ahead Logï¼‰æ”¯æŒ**: æä¾›æ•°æ®æŒä¹…æ€§ä¿è¯
3. **å¹¶å‘æ§åˆ¶ä¼˜åŒ–**: æ”¹è¿›è¯»å†™å¹¶å‘æ€§èƒ½
4. **ç¼“å­˜æœºåˆ¶**: æ·»åŠ  Block Cache æå‡è¯»å–æ€§èƒ½
5. **å‹ç¼©ç®—æ³•**: æ”¯æŒæ•°æ®å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´

## 4. å…ƒæ•°æ®ç®¡ç†

### æ¦‚è¿°

å…ƒæ•°æ®ç®¡ç†æ˜¯ Paimon çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£ç®¡ç†è¡¨çš„ç»“æ„å®šä¹‰ã€ç‰ˆæœ¬æ¼”åŒ–å’ŒæŒä¹…åŒ–ã€‚æœ¬æ–¹æ¡ˆä¸»è¦å®ç° Schema ç®¡ç†å’Œ Table å…ƒæ•°æ®ç®¡ç†ä¸¤å¤§æ¨¡å—ã€‚

### ä»»åŠ¡ 1ï¼šTable Schema ç®¡ç†

#### 1.1 Schema æ•°æ®ç»“æ„è®¾è®¡

**Schema ç±»**

æ ¸å¿ƒå­—æ®µï¼š
- schemaId: long - Schema ç‰ˆæœ¬å·ï¼Œä» 0 å¼€å§‹é€’å¢
- fields: List<Field> - å­—æ®µåˆ—è¡¨
- primaryKeys: List<String> - ä¸»é”®å­—æ®µååˆ—è¡¨
- partitionKeys: List<String> - åˆ†åŒºé”®å­—æ®µååˆ—è¡¨
- options: Map<String, String> - è¡¨çº§åˆ«é…ç½®é€‰é¡¹
- comment: String - è¡¨æ³¨é‡Šï¼ˆå¯é€‰ï¼‰
- timeMillis: long - Schema åˆ›å»ºæ—¶é—´æˆ³

**Field ç±»**

æ ¸å¿ƒå­—æ®µï¼š
- id: int - å­—æ®µå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äº Schema æ¼”åŒ–
- name: String - å­—æ®µåç§°
- type: DataType - å­—æ®µæ•°æ®ç±»å‹
- nullable: boolean - æ˜¯å¦å…è®¸ä¸ºç©º
- description: String - å­—æ®µæè¿°ï¼ˆå¯é€‰ï¼‰
- defaultValue: Object - é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰

**DataType æšä¸¾/ç±»**

æ”¯æŒçš„åŸºæœ¬ç±»å‹ï¼š
- INT (4å­—èŠ‚æ•´æ•°)
- BIGINT (8å­—èŠ‚é•¿æ•´æ•°)
- FLOAT (4å­—èŠ‚æµ®ç‚¹æ•°)
- DOUBLE (8å­—èŠ‚åŒç²¾åº¦æµ®ç‚¹æ•°)
- STRING (å˜é•¿å­—ç¬¦ä¸²)
- BOOLEAN (å¸ƒå°”å€¼)

#### 1.2 SchemaManager ç±»å®ç°

**æ ¸å¿ƒèŒè´£**
- Schema çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- Schema ç‰ˆæœ¬ç®¡ç†
- Schema è¯»å–å’Œç¼“å­˜
- Schema æ¼”åŒ–éªŒè¯

**ä¸»è¦æ–¹æ³•**

**createSchema**
- åŠŸèƒ½ï¼šåˆ›å»ºæ–°çš„ Schema
- è¾“å…¥ï¼šTableSchema, tablePath
- æµç¨‹ï¼š
  1. åˆ†é…æ–°çš„ schemaIdï¼ˆè¯»å–å½“å‰æœ€å¤§ ID + 1ï¼‰
  2. éªŒè¯ Schema åˆæ³•æ€§ï¼ˆä¸»é”®å­˜åœ¨æ€§ã€å­—æ®µåå”¯ä¸€æ€§ç­‰ï¼‰
  3. åºåˆ—åŒ–ä¸º JSON
  4. å†™å…¥æ–‡ä»¶ `{tablePath}/schema/schema-{schemaId}`
  5. æ›´æ–°Schema ID
- è¾“å‡ºï¼šschemaId

**commitSchema**
- åŠŸèƒ½ï¼šæäº¤ Schema æ¼”åŒ–
- è¾“å…¥ï¼šnewSchema, oldSchemaId, tablePath
- æµç¨‹ï¼š
  1. è¯»å–æ—§ Schema
  2. éªŒè¯ Schema æ¼”åŒ–å…¼å®¹æ€§
  3. åˆ†é…æ–° schemaId
  4. æŒä¹…åŒ–æ–° Schema

**getSchema**
- åŠŸèƒ½ï¼šæ ¹æ® ID è·å– Schema
- è¾“å…¥ï¼šschemaId, tablePath
- æµç¨‹ï¼š
  1. æ£€æŸ¥å†…å­˜ç¼“å­˜
  2. å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ–‡ä»¶è¯»å–
  3. ååºåˆ—åŒ– JSON
  4. æ›´æ–°ç¼“å­˜
  5. è¿”å› Schema å¯¹è±¡

**listSchemas**
- åŠŸèƒ½ï¼šåˆ—å‡ºæ‰€æœ‰å†å² Schema ç‰ˆæœ¬
- è¾“å…¥ï¼štablePath
- è¾“å‡ºï¼šList<Long> - æ‰€æœ‰ schemaId åˆ—è¡¨

#### 1.3 Schema æ–‡ä»¶ç»“æ„

**ç›®å½•å¸ƒå±€**

```
{tablePath}/
â”œâ”€â”€ schema/
â”‚   â”œâ”€â”€ schema-0          # åˆå§‹ Schema
â”‚   â”œâ”€â”€ schema-1          # ç¬¬ä¸€æ¬¡æ¼”åŒ–åçš„ Schema
â”‚   â”œâ”€â”€ schema-2          # ç¬¬äºŒæ¬¡æ¼”åŒ–åçš„ Schema
â”‚  
```

#### 1.4 Schema æ¼”åŒ–ç®¡ç†

**æ¼”åŒ–è§„åˆ™**

å…è®¸çš„æ¼”åŒ–æ“ä½œï¼š
- æ·»åŠ æ–°å­—æ®µï¼ˆå¿…é¡»æ˜¯ nullable æˆ–æœ‰é»˜è®¤å€¼ï¼‰
- ä¿®æ”¹å­—æ®µæ³¨é‡Š
- ä¿®æ”¹è¡¨æ³¨é‡Š
- æ·»åŠ è¡¨é€‰é¡¹

ç¦æ­¢çš„æ¼”åŒ–æ“ä½œï¼š
- åˆ é™¤å­—æ®µ
- ä¿®æ”¹å­—æ®µç±»å‹
- ä¿®æ”¹å­—æ®µ ID
- ä¿®æ”¹ä¸»é”®å®šä¹‰
- ä¿®æ”¹åˆ†åŒºé”®å®šä¹‰
- å°† nullable å­—æ®µæ”¹ä¸º non-nullable

**æ¼”åŒ–éªŒè¯é€»è¾‘**
`validateSchemaEvolution(oldSchema, newSchema)`:
1. æ£€æŸ¥ä¸»é”®æ˜¯å¦å˜åŒ–
2. æ£€æŸ¥åˆ†åŒºé”®æ˜¯å¦å˜åŒ–
3. éå†æ—§ Schema çš„å­—æ®µï¼š
   - éªŒè¯å­—æ®µæ˜¯å¦å­˜åœ¨äºæ–° Schema
   - éªŒè¯å­—æ®µ ID æœªæ”¹å˜
   - éªŒè¯å­—æ®µç±»å‹æœªæ”¹å˜
   - éªŒè¯ nullable å±æ€§æœªå˜ä¸¥æ ¼
4. éå†æ–°å¢å­—æ®µï¼š
   - éªŒè¯å¿…é¡»æ˜¯ nullable æˆ–æœ‰é»˜è®¤å€¼
   - åˆ†é…æ–°çš„ field IDï¼ˆä½¿ç”¨æœ€å¤§ ID + 1ï¼‰
5. æ‰€æœ‰æ£€æŸ¥é€šè¿‡æ‰å…è®¸æäº¤

**Field ID ç®¡ç†**

å­—æ®µ ID çš„ä½œç”¨ï¼š
- åœ¨ Schema æ¼”åŒ–æ—¶ä¿æŒå­—æ®µçš„ç¨³å®šæ ‡è¯†
- å³ä½¿å­—æ®µé‡å‘½åï¼ŒField ID ä¿æŒä¸å˜
- ç”¨äºæ•°æ®æ–‡ä»¶çš„åˆ—æ˜ å°„

åˆ†é…ç­–ç•¥ï¼š
- åˆå§‹ Schemaï¼šæŒ‰å­—æ®µé¡ºåºä» 0 å¼€å§‹
- Schema æ¼”åŒ–ï¼šæ–°å­—æ®µ ID = max(existing field IDs) + 1
- åˆ é™¤å­—æ®µå ID ä¸å¤ç”¨ï¼ˆé¿å…æ··æ·†ï¼‰

### ä»»åŠ¡ 2ï¼šTable å…ƒæ•°æ®ç®¡ç†

#### 2.2 SchemaManager ç±»å®ç°

**ä¸»è¦æ–¹æ³•**

**createTable**
- åŠŸèƒ½ï¼šåˆ›å»ºæ–°è¡¨çš„å…ƒæ•°æ®
- è¾“å…¥ï¼šSchema schema
- æµç¨‹ï¼š
  1. ç”Ÿæˆ tableUUID
  2. è®¾ç½®åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´
  3. åˆå§‹åŒ– snapshotId ä¸º -1
  4. åºåˆ—åŒ–ä¸º JSON
  5. å†™å…¥ `{tablePath}/metadata` æ–‡ä»¶
  6. è¿”å› TableSchema å¯¹è±¡

**updateTable**
- åŠŸèƒ½ï¼šæ›´æ–°è¡¨å…ƒæ•°æ®ï¼ˆSchemaï¼‰
- è¾“å…¥ï¼šupdated Schema
- æµç¨‹ï¼š
  1. å¯¹æ¯”æ—§ Schemaï¼Œæ ¡éªŒschemaæ˜¯å¦åˆæ³•
  2. æ›´æ–°ç›¸å…³å­—æ®µï¼ˆschemaIdç­‰ï¼‰
  3. åŸå­æ€§å†™å…¥æ–°æ–‡ä»¶ï¼ˆå†™ä¸´æ—¶æ–‡ä»¶ + renameï¼‰

#### 2.4 å…ƒæ•°æ®æŒä¹…åŒ–ç­–ç•¥

**åŸå­æ€§å†™å…¥**

å®ç°æ–¹å¼ï¼š
1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼š`{tablePath}/metadata.tmp.{timestamp}`
2. å†™å…¥å®Œæ•´çš„ JSON å†…å®¹
3. è°ƒç”¨ fsync ç¡®ä¿åˆ·ç›˜
4. åŸå­é‡å‘½åï¼š`metadata.tmp.{timestamp}` -> `metadata`
5. åˆ é™¤æ—§çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

ä¼˜ç‚¹ï¼š
- ä¿è¯å…ƒæ•°æ®æ–‡ä»¶çš„å®Œæ•´æ€§
- é¿å…å†™å…¥è¿‡ç¨‹ä¸­çš„æ–‡ä»¶æŸå
- æ”¯æŒå¹¶å‘å®‰å…¨

## 5. Snapshot æœºåˆ¶

### ä»»åŠ¡ 5.1ï¼šSnapshot è®¾è®¡

**ç›®æ ‡**ï¼šå®ç°ç‰ˆæœ¬æ§åˆ¶

**Snapshot æ–‡ä»¶ç»“æ„**ï¼š

```json
{
  "snapshotId": 1,
  "schemaId": 0,
  "commitTime": 1699000000,
  "manifestList": "manifest/manifest-list-1"
}
```

**Timeline**:

```
snapshot-1 â”€â”€â–¶ snapshot-2 â”€â”€â–¶ snapshot-3 (LATEST)
    â”‚              â”‚              â”‚
    â–¼              â–¼              â–¼
manifest-1     manifest-2     manifest-3
```

- å®ç° Snapshot ç±»
- æ–‡ä»¶å‘½åï¼šsnapshot/snapshot-{id}
- ç»´æŠ¤ LATEST æŒ‡é’ˆï¼ˆè½¯é“¾æ¥æˆ–æ ‡è®°æ–‡ä»¶ï¼‰
- å®ç°å¿«ç…§çš„åˆ›å»ºå’Œè¯»å–

### ä»»åŠ¡ 5.2ï¼šManifest æ–‡ä»¶

**ç›®æ ‡**ï¼šè¿½è¸ªæ•°æ®æ–‡ä»¶å˜æ›´

**Manifest List æ ¼å¼**ï¼š

```json
{
  "manifestFiles": [
    "manifest/manifest-abc123",
    "manifest/manifest-def456"
  ]
}
```

**Manifest File æ ¼å¼**ï¼š

```json
{
  "entries": [
    {
      "kind": "ADD",
      "file": "data/data-0-001.sst",
      "level": 0,
      "minKey": "...",
      "maxKey": "...",
      "rowCount": 1000
    }
  ]
}
```

- å®ç° ManifestEntry ç±»ï¼ˆADD/DELETEï¼‰
- å®ç° ManifestFile ç±»
- å®ç° ManifestList ç±»
- å†™å…¥æ—¶å¢é‡è®°å½•æ–‡ä»¶å˜æ›´
- è¯»å–æ—¶åˆå¹¶æ‰€æœ‰ Manifest å¾—åˆ°å½“å‰æ–‡ä»¶åˆ—è¡¨

### ä»»åŠ¡ 5.3ï¼šå¿«ç…§è¯»å–æµç¨‹

**ç›®æ ‡**ï¼šå®ç°æ—¶é—´æ—…è¡ŒæŸ¥è¯¢

**Read Flow**:

```
Query â”€â”€â–¶ Load Latest Snapshot â”€â”€â–¶ Read Manifest â”€â”€â–¶ Get File List
                                                          â”‚
                                                          â–¼
                                    Merge Read from Multiple SSTables
```

- æ ¹æ® Snapshot ID åŠ è½½å¯¹åº”ç‰ˆæœ¬
- è§£æ Manifest è·å–æ‰€æœ‰æ´»è·ƒæ–‡ä»¶
- åˆå¹¶å¤šä¸ª SSTable çš„æŸ¥è¯¢ç»“æœï¼ˆæŒ‰ Key å»é‡ï¼Œå–æœ€æ–°ï¼‰

## 6. æ–‡ä»¶ç»„ç»‡ç»“æ„

### ä»»åŠ¡ 6.1ï¼šç›®å½•ç»“æ„è®¾è®¡

**ç›®æ ‡**ï¼šå‚è€ƒ Paimon çš„ç›®å½•å¸ƒå±€

```
warehouse/
â””â”€â”€ {database}/
    â””â”€â”€ {table}/
        â”œâ”€â”€ schema/
        â”‚   â”œâ”€â”€ schema-0
        â”‚   â””â”€â”€ schema-1
        â”œâ”€â”€ snapshot/
        â”‚   â”œâ”€â”€ snapshot-1
        â”‚   â”œâ”€â”€ snapshot-2
        â”‚   â””â”€â”€ LATEST
        â”œâ”€â”€ manifest/
        â”‚   â”œâ”€â”€ manifest-list-1
        â”‚   â”œâ”€â”€ manifest-abc123
        â”‚   â””â”€â”€ manifest-def456
        â””â”€â”€ data/
            â”œâ”€â”€ data-0-001.sst
            â”œâ”€â”€ data-0-002.sst
            â””â”€â”€ data-1-001.sst
```

- å®ç° PathFactory å·¥å…·ç±»
- è‡ªåŠ¨åˆ›å»ºç›®å½•ç»“æ„
- å®ç°æ–‡ä»¶æ¸…ç†ï¼ˆæ—§å¿«ç…§çš„åƒåœ¾å›æ”¶ï¼‰

## 7. LSM Tree ä¸ Snapshot é›†æˆ

**ç›®æ ‡**ï¼šå°† LSM Tree å­˜å‚¨å¼•æ“ä¸ Snapshot æœºåˆ¶é›†æˆ

- ä¿®æ”¹ LSMTree ç±»ï¼Œåœ¨æ•°æ®åˆ·å†™æ—¶åˆ›å»ºå¿«ç…§
- å®ç°æ•°æ®æ–‡ä»¶å˜æ›´çš„è‡ªåŠ¨è®°å½•åˆ° Manifest
- éªŒè¯å¿«ç…§æœºåˆ¶çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
- æä¾›æ—¶é—´æ—…è¡ŒæŸ¥è¯¢èƒ½åŠ›

## 8. é€šè¿‡ SQL è¯»å†™æ•°æ®æµç¨‹

### ä¸€ã€é¡¹ç›®æ•´ä½“æ¶æ„

#### 1.1 æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

- **SQLè§£ææ¨¡å—**ï¼šè´Ÿè´£è§£æCREATE TABLEå’ŒINSERTè¯­å¥
- **Schemaç®¡ç†æ¨¡å—**ï¼šè´Ÿè´£è¡¨ç»“æ„çš„åˆ›å»ºã€å­˜å‚¨å’Œæ£€ç´¢
- **æ•°æ®å†™å…¥æ¨¡å—**ï¼šè´Ÿè´£å°†æ•°æ®å†™å…¥Snapshotæ–‡ä»¶
- **å…ƒæ•°æ®ç®¡ç†æ¨¡å—**ï¼šè´Ÿè´£ç®¡ç†è¡¨çš„å…ƒæ•°æ®ä¿¡æ¯
- **æ–‡ä»¶å­˜å‚¨æ¨¡å—**ï¼šè´Ÿè´£åº•å±‚æ–‡ä»¶çš„è¯»å†™æ“ä½œ

### äºŒã€CREATE TABLE åŠŸèƒ½å®ç°æµç¨‹

#### 2.1 SQLè§£æé˜¶æ®µ

**è¯æ³•åˆ†æ**
- å°†CREATE TABLE SQLè¯­å¥åˆ†è§£ä¸ºTokenåºåˆ—
- è¯†åˆ«å…³é”®å­—ï¼šCREATE, TABLE, åˆ—å, æ•°æ®ç±»å‹, çº¦æŸç­‰

**è¯­æ³•åˆ†æ**
- æ„å»ºæŠ½è±¡è¯­æ³•æ ‘(AST)
- æå–è¡¨åã€åˆ—å®šä¹‰ã€ä¸»é”®ã€åˆ†åŒºé”®ç­‰ä¿¡æ¯
- éªŒè¯SQLè¯­æ³•çš„æ­£ç¡®æ€§

**è¯­ä¹‰åˆ†æ**
- æ£€æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨
- éªŒè¯æ•°æ®ç±»å‹çš„åˆæ³•æ€§
- éªŒè¯çº¦æŸæ¡ä»¶çš„åˆç†æ€§

#### 2.2 Schemaç”Ÿæˆé˜¶æ®µ

**Schemaå¯¹è±¡æ„å»º**
- åˆ›å»ºTableSchemaå¯¹è±¡
- åŒ…å«å­—æ®µï¼š
  - è¡¨å(tableName)
  - åˆ—ä¿¡æ¯åˆ—è¡¨(columns)ï¼šåˆ—åã€æ•°æ®ç±»å‹ã€æ˜¯å¦å¯ç©ºã€é»˜è®¤å€¼
  - ä¸»é”®ä¿¡æ¯(primaryKeys)
  - åˆ†åŒºé”®ä¿¡æ¯(partitionKeys)
  - è¡¨å±æ€§(properties)ï¼šå¦‚å­˜å‚¨æ ¼å¼ã€å‹ç¼©æ–¹å¼ç­‰
  - Schemaç‰ˆæœ¬å·(schemaId)
  - åˆ›å»ºæ—¶é—´æˆ³

**SchemaéªŒè¯**
- éªŒè¯ä¸»é”®åˆ—å¿…é¡»å­˜åœ¨äºåˆ—å®šä¹‰ä¸­
- éªŒè¯åˆ†åŒºé”®çš„åˆæ³•æ€§
- æ£€æŸ¥åˆ—åæ˜¯å¦é‡å¤

#### 2.3 SchemaæŒä¹…åŒ–é˜¶æ®µ

**æ–‡ä»¶è·¯å¾„è§„åˆ’**
- ç›®å½•ç»“æ„ï¼š{warehouse_path}/{database}/{table}/schema/
- æ–‡ä»¶å‘½åï¼šschema-{schemaId}.json æˆ– schema-{schemaId}.avro

**åºåˆ—åŒ–Schema**
- å°†Schemaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONæˆ–Avroæ ¼å¼
- åŒ…å«å®Œæ•´çš„è¡¨ç»“æ„ä¿¡æ¯

**å†™å…¥ç£ç›˜**
- ä½¿ç”¨åŸå­å†™æ“ä½œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- å…ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼Œå†é‡å‘½åä¸ºæ­£å¼æ–‡ä»¶
- æ›´æ–°æœ€æ–°SchemaæŒ‡é’ˆæ–‡ä»¶(latest-schema)

**å…ƒæ•°æ®æ³¨å†Œ**
- åœ¨å…ƒæ•°æ®ç›®å½•ä¸­è®°å½•è¡¨çš„åŸºæœ¬ä¿¡æ¯
- å»ºç«‹è¡¨ååˆ°Schemaæ–‡ä»¶çš„æ˜ å°„å…³ç³»

### ä¸‰ã€INSERT åŠŸèƒ½å®ç°æµç¨‹

#### 3.1 SQLè§£æé˜¶æ®µ

**è¯æ³•å’Œè¯­æ³•åˆ†æ**
- è§£æINSERT INTOè¯­å¥
- æå–ç›®æ ‡è¡¨å
- æå–åˆ—ååˆ—è¡¨(å¦‚æœæŒ‡å®š)
- æå–VALUESå­å¥ä¸­çš„æ•°æ®å€¼

**æ•°æ®æå–**
- å°†VALUESä¸­çš„æ•°æ®è§£æä¸ºè¡Œè®°å½•
- æ”¯æŒå¤šè¡Œæ’å…¥ï¼šINSERT INTO table VALUES (row1), (row2), ...
- å¤„ç†æ•°æ®ç±»å‹è½¬æ¢

#### 3.2 SchemaæŸ¥æ‰¾ä¸éªŒè¯é˜¶æ®µ

**å®šä½Schemaæ–‡ä»¶**
- æ ¹æ®è¡¨åæŸ¥æ‰¾å¯¹åº”çš„Schemaç›®å½•
- è¯»å–latest-schemaæŒ‡é’ˆï¼Œè·å–æœ€æ–°çš„Schemaç‰ˆæœ¬
- åŠ è½½Schemaæ–‡ä»¶åˆ°å†…å­˜

**æ•°æ®éªŒè¯**
- éªŒè¯æ’å…¥çš„åˆ—æ•°ä¸Schemaå®šä¹‰æ˜¯å¦åŒ¹é…
- éªŒè¯æ•°æ®ç±»å‹æ˜¯å¦å…¼å®¹
- æ£€æŸ¥NOT NULLçº¦æŸ
- éªŒè¯ä¸»é”®å”¯ä¸€æ€§(å¯é€‰ï¼Œç®€åŒ–ç‰ˆæœ¬å¯æš‚ä¸å®ç°)

**æ•°æ®è½¬æ¢ä¸å¡«å……**
- å¦‚æœINSERTè¯­å¥æœªæŒ‡å®šåˆ—åï¼ŒæŒ‰Schemaé¡ºåºå¡«å……
- å¦‚æœæŒ‡å®šäº†åˆ—åï¼ŒæŒ‰æ˜ å°„å…³ç³»å¡«å……æ•°æ®
- ä¸ºæœªæŒ‡å®šçš„åˆ—å¡«å……é»˜è®¤å€¼æˆ–NULL

#### 3.3 æ•°æ®å†™å…¥Snapshoté˜¶æ®µ

**ç¡®å®šå†™å…¥ä½ç½®**
- ç›®å½•ç»“æ„ï¼š{warehouse_path}/{database}/{table}/snapshot/
- æ ¹æ®åˆ†åŒºé”®è®¡ç®—åˆ†åŒºè·¯å¾„(å¦‚æœ‰åˆ†åŒº)

**æ„å»ºSnapshotå¯¹è±¡**
- ç”Ÿæˆå”¯ä¸€çš„Snapshot ID(é€’å¢æˆ–æ—¶é—´æˆ³)
- è®°å½•å†™å…¥ä¿¡æ¯ï¼š
  - commitIdï¼šæäº¤æ ‡è¯†
  - schemaIdï¼šä½¿ç”¨çš„Schemaç‰ˆæœ¬
  - timestampï¼šæäº¤æ—¶é—´
  - operationï¼šæ“ä½œç±»å‹(INSERT)
  - dataFilesListï¼šæ•°æ®æ–‡ä»¶åˆ—è¡¨

**æ•°æ®æ–‡ä»¶å†™å…¥**
- æ–‡ä»¶æ ¼å¼é€‰æ‹©ï¼š
  - ç®€å•å®ç°ï¼šJSONæ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡
  - è¿›é˜¶å®ç°ï¼šParquetæˆ–ORCç­‰åˆ—å¼å­˜å‚¨æ ¼å¼
- æ•°æ®æ–‡ä»¶å‘½åï¼š
  - data-{commitId}-{fileId}.{format}
  - ä¾‹å¦‚ï¼šdata-000001-001.json
- å†™å…¥æµç¨‹ï¼š
  - å°†éªŒè¯åçš„æ•°æ®è¡Œåºåˆ—åŒ–
  - æŒ‰æ‰¹æ¬¡å†™å…¥æ•°æ®æ–‡ä»¶
  - è®¡ç®—æ•°æ®æ–‡ä»¶çš„ç»Ÿè®¡ä¿¡æ¯(è¡Œæ•°ã€æ–‡ä»¶å¤§å°ç­‰)

**Snapshotå…ƒæ•°æ®å†™å…¥**
- Snapshotæ–‡ä»¶å‘½åï¼šsnapshot-{snapshotId}.json
- Snapshotå†…å®¹ï¼š

```json
{
  "snapshotId": 1,
  "schemaId": 0,
  "commitId": 1,
  "timestamp": 1699123456789,
  "operation": "INSERT",
  "dataFiles": [
    {
      "path": "data-000001-001.json",
      "rowCount": 100,
      "fileSize": 1024,
      "minValues": {...},
      "maxValues": {...}
    }
  ],
  "summary": {
    "totalRecords": 100,
    "totalFiles": 1
  }
}
```

**æ›´æ–°Snapshoté“¾**
- æ›´æ–°latest-snapshotæŒ‡é’ˆæŒ‡å‘æ–°çš„Snapshot
- ç»´æŠ¤Snapshotçš„ç‰ˆæœ¬é“¾(å¯é€‰ï¼Œç”¨äºæ—¶é—´æ—…è¡ŒåŠŸèƒ½)

### å››ã€å…³é”®æ•°æ®ç»“æ„è®¾è®¡

#### 4.1 Schemaç›¸å…³

**TableSchema:**
- tableName: String
- schemaId: Long
- columns: List<Column>
- primaryKeys: List<String>
- partitionKeys: List<String>
- properties: Map<String, String>
- createTime: Long

**Column:**
- name: String
- dataType: DataType
- nullable: Boolean
- defaultValue: Object
- comment: String

#### 4.2 Snapshotç›¸å…³

**Snapshot:**
- snapshotId: Long
- schemaId: Long
- commitId: Long
- timestamp: Long
- operation: OperationType
- dataFiles: List<DataFile>
- summary: CommitSummary

**DataFile:**
- path: String
- rowCount: Long
- fileSize: Long
- minValues: Map<String, Object>
- maxValues: Map<String, Object>

### äº”ã€ç›®å½•ç»“æ„è®¾è®¡

```
warehouse/
â”œâ”€â”€ {database}/
â”‚   â””â”€â”€ {table}/
â”‚       â”œâ”€â”€ schema/
â”‚       â”‚   â”œâ”€â”€ schema-0.json
â”‚       â”‚   â”œâ”€â”€ schema-1.json
â”‚       â”‚   â””â”€â”€ latest-schema (æŒ‡å‘æœ€æ–°schema)
â”‚       â”œâ”€â”€ snapshot/
â”‚       â”‚   â”œâ”€â”€ snapshot-1.json
â”‚       â”‚   â”œâ”€â”€ snapshot-2.json
â”‚       â”‚   â””â”€â”€ latest-snapshot (æŒ‡å‘æœ€æ–°snapshot)
â”‚       â””â”€â”€ data/
â”‚           â”œâ”€â”€ data-000001-001.json
â”‚           â”œâ”€â”€ data-000002-001.json
â”‚           â””â”€â”€ ...
```

### å…­ã€å®ç°å»ºè®®

#### 6.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½

- å®ç°ç®€å•çš„SQLè§£æå™¨(å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–æ‰‹å†™Parser)
- æ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹ï¼šINT, BIGINT, STRING, DOUBLE, BOOLEAN
- ä½¿ç”¨JSONæ ¼å¼å­˜å‚¨Schemaå’Œæ•°æ®æ–‡ä»¶
- å•çº¿ç¨‹ã€æ— å¹¶å‘æ§åˆ¶

#### 6.2 ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å¢å¼º

- å¼•å…¥SQLè§£æåº“(å¦‚Apache Calciteã€JSqlParser)
- æ”¯æŒæ›´å¤šæ•°æ®ç±»å‹å’Œå¤æ‚è¡¨è¾¾å¼
- æ·»åŠ æ•°æ®æ ¡éªŒå’Œç±»å‹è½¬æ¢
- å®ç°åŸºæœ¬çš„é”™è¯¯å¤„ç†æœºåˆ¶

#### 6.3 ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨é«˜æ•ˆçš„å­˜å‚¨æ ¼å¼(Parquetã€ORC)
- å®ç°æ‰¹é‡å†™å…¥ä¼˜åŒ–
- æ·»åŠ ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
- å®ç°ç®€å•çš„å¹¶å‘æ§åˆ¶

### ä¸ƒã€æµ‹è¯•å»ºè®®

#### 7.1 å•å…ƒæµ‹è¯•

- SQLè§£æå™¨æµ‹è¯•ï¼šå„ç§SQLè¯­æ³•
- Schemaåºåˆ—åŒ–/ååºåˆ—åŒ–æµ‹è¯•
- æ•°æ®ç±»å‹è½¬æ¢æµ‹è¯•
- æ–‡ä»¶è¯»å†™æµ‹è¯•

#### 7.2 é›†æˆæµ‹è¯•

- ç«¯åˆ°ç«¯CREATE TABLEæµ‹è¯•
- ç«¯åˆ°ç«¯INSERTæµ‹è¯•
- Schemaç‰ˆæœ¬å‡çº§æµ‹è¯•
- å¤šæ¬¡INSERTåçš„æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

#### 7.3 è¾¹ç•Œæµ‹è¯•

- ç©ºè¡¨æ’å…¥
- å¤§æ‰¹é‡æ•°æ®æ’å…¥
- å¼‚å¸¸SQLè¯­å¥å¤„ç†
- æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸å¤„ç†